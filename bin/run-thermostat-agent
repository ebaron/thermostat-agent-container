#!/bin/bash
if [ ! -d "${USER_THERMOSTAT_HOME}/etc" ]; then
  mkdir -p "${USER_THERMOSTAT_HOME}/etc"
fi

plugins="vm-gc vm-memory host-overview commands"
for plugin in ${plugins}; do
  prop_file=${THERMOSTAT_HOME}/etc/plugins.d/${plugin}/gateway.properties
  if [ ! -e "${prop_file}" ]; then
    echo 1>&2 "Properties file for ${plugin} is missing. This script is out-of-date!"
    exit 1
  fi
  user_prop_dir=${USER_THERMOSTAT_HOME}/etc/plugins.d/${plugin}
  if [ ! -d "${user_prop_dir}" ]; then
    mkdir -p "${user_prop_dir}"
  fi
  user_prop_file="${user_prop_dir}"/gateway.properties

  # Derive config environment variable from plugin name
  url_var="THERMOSTAT_$(echo ${plugin} | tr '[:lower:]-' '[:upper:]_')_URL"
  if [ -z "${!url_var}" ]; then
    echo 1>&2 "Required environment variable ${url_var} not set"
    exit 1
  fi

  # Replace default URL with value of environment variable
  sed "s|gatewayURL=.*|gatewayURL=${!url_var}|" "${prop_file}" > "${user_prop_file}"
done

# Run the agent
${THERMOSTAT_HOME}/bin/thermostat agent
